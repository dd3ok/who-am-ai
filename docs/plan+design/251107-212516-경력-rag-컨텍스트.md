# Plan+Design — 경력 질의 RAG 컨텍스트 실패 수정

## 목적 / 문제정의
- 규칙 기반 컨텍스트 조회에서 `경력/이력` 키워드를 인식했음에도 VectorStore에서 콘텐츠를 찾지 못해 일반 대화 프롬프트로 전환되는 문제를 해결한다.
- 원인: MongoDB Atlas VectorStore 문서 `_id`가 자동 생성되는데, `ContextRetriever`는 `ChunkIdGenerator`로 만든 ID로 조회만 수행해 항상 `null`이 반환된다.

## 범위(Scope)
- 포함: `MongoVectorAdapter`의 `findChunkById` 구현 개선, 필요한 경우 부수적인 메타데이터 보정.
- 제외: Chunk 생성 로직, Router/Prompt 로직, Vector 검색 파라미터 변경.

## 입력 / 출력 / 의존성
- 입력: `ContextRetriever`가 전달하는 `chunkId` (`experience_*`, `project_*` 등).
- 출력: 규칙 기반으로 즉시 사용할 수 있는 이력서 섹션 문자열.
- 참조: `resume_chunks` 컬렉션(`metadata.chunk_id`, `content` 필드).
- 환경: Spring AI MongoDB Atlas VectorStore + ReactiveMongoTemplate.

## 데이터 흐름(DFD) / 시퀀스
- ChatService → ContextRetriever → ResumePersistencePort → MongoVectorAdapter → MongoDB.
- 문서 저장 시 `metadata.chunk_id`로 Chunk ID를 넣어두므로, 조회 시 `_id` 대신 해당 필드를 조건으로 사용한다.

## 설계(아키텍처 / 모듈 / 의존성)
- `MongoVectorAdapter.findChunkById`에서 `reactiveMongoTemplate.findById` 대신 `findOne(Query(Criteria.where("metadata.chunk_id").is(id)))` 사용.
- 재사용을 위해 `chunkIdCriteria(id)` 헬퍼 또는 인라인 Criteria 적용.
- 기존 `ResumeChunkDocument`를 그대로 재사용 (content 추출 목적).
- 필요한 경우 `metadata.chunk_id`가 비어있는 문서를 대비해 WARN 로그 남기고 `null` 반환.

## 리스크 / 가정
- 리스크: 과거에 색인된 문서에 `chunk_id` 메타데이터가 누락됐을 가능성. → 조회 실패 시 경고 로그로 재색인 필요성을 노출.
- 가정: `ManageResumeService.reindexResumeData()`가 주기적으로 실행되어 컬렉션을 최신 상태로 유지한다.

## 완료 기준(DoD)
- 규칙 기반으로 `experiences`, `projects` 등을 조회하면 최소 한 개 이상의 콘텐츠가 반환된다.
- 동일 질문에 대해 RAG 프롬프트가 선택되고, 벡터 검색 fallback 없이 답을 생성한다.
- 단위 수준(또는 간단한 통합) 테스트 시나리오 문서화.
- 로그에 실패/예외가 새로 발생하지 않는다.

## Why / Scope 기록
- Why: `_id` 대신 `metadata.chunk_id`를 사용해야만 규칙 기반 ID 조회가 성공해 사용자 질문에 바로 응답할 수 있다.
- Scope 근거: 문제는 VectorStore 조회 레이어에서만 발생하므로 해당 포트 구현을 수정하면 상위 계층 변경 없이 해결 가능하다.
