# Implement — Spring AI 이미지 경로 통합

## 변경 요약
- `GeminiAdapter`가 Spring AI `ImageModel` 추상화를 이용해 의류 교체 이미지를 생성하도록 리팩터링하고, `GeminiPort`에 `generateStyledImage` 계약을 추가했다.
- Google SDK 호출을 Spring AI 인터페이스로 감싸는 `GeminiAIFittingImageModel`과 `GeminiFittingImageOptions`를 신설해 이미지 입력/옵션을 `ImagePrompt` 흐름으로 전달한다.
- `AIFittingService`는 더 이상 Adapter 구현에 직접 의존하지 않고 `GeminiPort`를 주입받아 오류 처리만 담당하도록 단순화했다.
- `GeminiImageModelProperties`/`application.yml`에 이미지 모델 온도·시드·MIME 타입을 명시했고, 관련 Plan·Implement 문서를 작성했다.

## Why / Scope
- Why: 텍스트 경로와 동일하게 Spring AI 계층을 사용하면 Gemini 의존성 변경 시 단일 Adapter만 수정하면 되어 유지보수가 쉬워진다.
- Scope: 이미지 생성 파이프라인에 한정해 Spring AI `ImageModel`로 감싸고, 나머지 비즈니스/Vector/RAG 경로는 변경하지 않았다.

## Plan 대비 변경 사항 (Drift)
- Spring AI가 Google 이미지 모델 AutoConfig를 아직 제공하지 않아 Plan에서 예상한 “기성 ImageModel Bean” 대신 커스텀 `GeminiAIFittingImageModel`을 구현해 동일 인터페이스를 충족시켰다. (see: Plan+Design#251107-213522-springai-이미지경로-통합)

## 코드 주요 포인트
- `GeminiAIFittingImageModel` (`src/main/kotlin/com/dd3ok/whoamai/adapter/out/gemini/GeminiAIFittingImageModel.kt`)이 Google SDK `Client` 호출을 담당하고, 응답을 `ImageResponse`로 변환한다.
- `GeminiAdapter` (`.../GeminiAdapter.kt`)는 새로운 `generateStyledImage` 구현에서 `GeminiFittingImageOptions`를 생성해 Spring AI ImageModel을 호출한 후 Base64 디코딩만 수행한다.
- `AIFittingService` (`.../AIFittingService.kt`)는 `GeminiPort`만 호출하도록 단순화되어 도메인 서비스가 Adapter 세부 구현을 직접 다루지 않는다.
- 환경 설정(`GeminiImageModelProperties`, `application.yml`)에 이미지 전용 옵션을 명시해 런타임 튜닝과 재사용성을 높였다.

## 배치/운영 플로우
- 별도 배치/스케줄 추가 없음. 기존 `GEMINI_API_KEY`와 `spring.ai.google.genai.image.*` 속성만 세팅되어 있으면 Spring AI Bean과 커스텀 ImageModel이 자동으로 주입된다.

## 테스트 시나리오 & 예상 결과 (실행하지 않음)
- 시나리오 1: 의류·인물 이미지를 업로드해 `/ai/fitting` 경로 호출 → Spring AI ImageModel이 Base64 이미지를 반환하고 최종 ByteArray가 응답으로 전송된다.
- 시나리오 2: 빈 파일 업로드 → `GeminiFittingImageOptions`의 `require` 검증으로 즉시 예외 발생, 서비스 계층에서 사용자 오류 메시지를 노출한다.
- 엣지 케이스: Gemini API에서 후보가 비어 있는 경우 → `IllegalStateException("no candidates")`로 로깅 후 상위 서비스에서 래핑 예외를 던진다.

## 작업 체크리스트
- [✅] Spring AI ImageModel 기반 이미지 생성 파이프라인 구축
- [✅] GeminiPort/AIFittingService 구조 정리
- [✅] 설정 및 Why/Scope/Drift 문서화
